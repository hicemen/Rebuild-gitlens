name: Fix gitlens and build

on:
    schedule:
        - cron: '0 0 * * *'
    workflow_dispatch:
        inputs:
            version:
                description: 'Release version (e.g., v17.8.1). Leave empty for latest'
                required: false
                type: string

jobs:
    sync-release:
        name: Sync Release
        runs-on: ubuntu-latest
        permissions:
            contents: write
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup node
              uses: actions/setup-node@v4
              with:
                  node-version: '22'

            - name: Setup pnpm
              uses: pnpm/action-setup@v3
              with:
                  version: 10

            - name: Check if tag exists locally
              id: check_tag
              run: |
                  if [ -n "${{ github.event.inputs.version }}" ]; then
                      VERSION="${{ github.event.inputs.version }}"
                  else
                      VERSION=$(curl -s https://api.github.com/repos/gitkraken/vscode-gitlens/releases/latest | grep '"tag_name":' | cut -d'"' -f4)
                      echo "Latest version: $VERSION"
                  fi
                  echo "VERSION=$VERSION" >> $GITHUB_ENV

                  if git rev-parse "$VERSION" >/dev/null 2>&1; then
                      echo "Tag exists, skipping..."
                      echo "exists=true" >> $GITHUB_OUTPUT
                  else
                      echo "exists=false" >> $GITHUB_OUTPUT
                  fi

            - name: Exit if tag exists
              if: steps.check_tag.outputs.exists == 'true'
              run: |
                  echo "Tag ${{ env.VERSION }} already exists, exiting."
                  exit 0

            - name: Fetch upstream release
              run: |
                  git fetch https://github.com/gitkraken/vscode-gitlens.git refs/tags/${{ env.VERSION }}:refs/tags/${{ env.VERSION }} --depth=1

            - name: Checkout upstream release
              run: |
                  git checkout ${{ env.VERSION }}

            - name: 拉取patches
              uses: actions/checkout@v4
              with:
                  repository: ${{ github.repository }}
                  path: source-repo
                  sparse-checkout: |
                    patches
                  sparse-checkout-cone-mode: false

            - name: Apply patches
              run: |
                  echo "Applying patches..."
                  for patch in source-repo/patches/*.patch; do
                      if [ -f "$patch" ]; then
                          echo "Applying patch: $patch"
                          git apply "$patch" || echo "Failed to apply $patch"
                      fi
                  done

            - name: Remove source-repo
              run: |
                  rm -rf source-repo

            - name: Install dependencies
              run: pnpm install

            - name: Package extension
              run: pnpm package

            - name: Get package name
              run: |
                  echo "PACKAGE_NAME=$(node -e "console.log(require('./package.json').name + '-' + require('./package.json').version + '.vsix')")" >> $GITHUB_ENV
                  echo "PACKAGE_VERSION=$(node -e "console.log(require('./package.json').version)")" >> $GITHUB_ENV
                  
            - name: Generate Changelog
              id: changelog
              uses: mindsers/changelog-reader-action@v2
              with:
                  version: ${{ env.PACKAGE_VERSION }}
                  path: ./CHANGELOG.md

            - name: Create GitHub release
              uses: softprops/action-gh-release@v2
              env:
                  GITHUB_TOKEN: ${{ secrets.GIT_TOKEN }}
              with:
                  tag_name: ${{ env.VERSION }}
                  name: GitLens ${{ env.PACKAGE_VERSION }}
                  body: ${{ steps.changelog.outputs.changes }}
                  draft: false
                  prerelease: false
                  files: ./${{ env.PACKAGE_NAME }}
