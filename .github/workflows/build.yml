name: Fix gitlens and build

on:
    schedule:
        - cron: '0 0 * * *'
    workflow_dispatch:
        inputs:
            version:
                description: 'Release version (e.g., v17.8.1). Leave empty for latest'
                required: false
                type: string

jobs:
    sync-release:
        name: Sync Release
        runs-on: ubuntu-latest
        permissions:
            contents: write
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup node
              uses: actions/setup-node@v4
              with:
                  node-version: '22'

            - name: Setup pnpm
              uses: pnpm/action-setup@v3
              with:
                  version: 10

            - name: Check if tag exists locally
              id: check_tag
              run: |
                  if [ -n "${{ github.event.inputs.version }}" ]; then
                      VERSION="${{ github.event.inputs.version }}"
                  else
                      VERSION=$(curl -s https://api.github.com/repos/gitkraken/vscode-gitlens/releases/latest | grep '"tag_name":' | cut -d'"' -f4)
                      echo "Latest version: $VERSION"
                  fi
                  echo "VERSION=$VERSION" >> $GITHUB_ENV

                  if git rev-parse "$VERSION" >/dev/null 2>&1; then
                      echo "Tag exists, skipping..."
                      echo "exists=true" >> $GITHUB_OUTPUT
                  else
                      echo "exists=false" >> $GITHUB_OUTPUT
                  fi

            - name: Exit if tag exists
              if: steps.check_tag.outputs.exists == 'true'
              run: |
                  echo "Tag ${{ env.VERSION }} already exists, exiting."
                  exit 0

            - name: Fetch upstream release
              run: |
                  git fetch https://github.com/gitkraken/vscode-gitlens.git refs/tags/${{ env.VERSION }}:refs/tags/${{ env.VERSION }} --depth=1

            - name: Get release info from upstream
              id: release_info
              uses: actions/github-script@v7
              with:
                  result-encoding: json
                  script: |
                      const { data: release } = await github.rest.repos.getReleaseByTag({
                          owner: 'gitkraken',
                          repo: 'vscode-gitlens',
                          tag: '${{ env.VERSION }}'
                      });
                      return {
                          body: release.body,
                          name: release.name,
                          html_url: release.html_url
                      };

            - name: Checkout upstream release
              run: |
                  git checkout ${{ env.VERSION }}

            - name: Apply patches
              run: |
                  echo "Applying patches..."
                  for patch in patches/*.patch; do
                      if [ -f "$patch" ]; then
                          echo "Applying patch: $patch"
                          git apply "$patch" || echo "Failed to apply $patch"
                      fi
                  done

            - name: Install dependencies
              run: pnpm install

            - name: Package extension
              run: pnpm package

            - name: Get package name
              run: |
                  echo "PACKAGE_NAME=$(node -e "console.log(require('./package.json').name + '-' + require('./package.json').version + '.vsix')")" >> $GITHUB_ENV
                  echo "PACKAGE_VERSION=$(node -e "console.log(require('./package.json').version)")" >> $GITHUB_ENV

            - name: Create GitHub release
              uses: softprops/action-gh-release@v2
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              with:
                  tag_name: ${{ env.VERSION }}
                  name: GitLens ${{ env.PACKAGE_VERSION }}
                  body: |
                      **Changes in this release:**

                      ${{ steps.release_info.result.body }}

                      **Download:** [VSIX Package](https://github.com/${{ github.repository }}/releases/download/${{ env.VERSION }}/${{ env.PACKAGE_NAME }})
                  draft: false
                  prerelease: false
                  files: ./${{ env.PACKAGE_NAME }}
